# CI/CD Integration (Project 1 → Project 4 → Project 6)

This document describes how Project 1 connects to Project 6 via Project 4, with **auto-sync enabled for dev, pre, and prod** Argo CD Applications.

---

## 1. Build Stage (Project 1)

Project 1 performs:

1. Docker build  
2. Tag with the commit SHA  
3. Push to Amazon ECR  

The resulting image is what all environments (dev, pre, prod) will eventually run once their values files reference the new tag.

---

## 2. Update Stage (Project 1 → Project 4)

After pushing the image, Project 1 updates **Project 4**:

```text
project4-helm-argo-gitops / values-dev.yaml
project4-helm-argo-gitops / values-pre.yaml
project4-helm-argo-gitops / values-prod.yaml
```

Specifically, the `image.tag` value is replaced with the new SHA in **all three** environment values files.

---

## 3. Argo CD Detection

Argo CD watches the `project4-gitops` branch in **Project 4**.

When the values files change:

- Argo CD re-syncs the **dev**, **pre**, and **prod** Applications generated by the Project 6 ApplicationSet:
  - `project6-dev` (namespace: `project6-dev`)
  - `project6-pre` (namespace: `project6-pre`)
  - `project6-prod` (namespace: `project6-prod`)

Because **auto-sync is enabled for all three**, each environment rolls out the new image tag as soon as its values file is updated by CI.

---

## 4. Pre and Prod Flow (Auto-Sync, Promotion via Values Files)

Because CI updates all three values files for this learning project, dev, pre, and prod all receive the new image automatically.

> **Real-world note:** In a production system, you would typically restrict CI to updating **dev** only and use Git-based promotion (PRs or a dedicated pipeline) to move a given image tag into `values-pre.yaml` and `values-prod.yaml`.

---

## 5. Future Enhancements

Future projects could:

- Introduce a dedicated **promotion pipeline** that:
  - Reads the dev image tag
  - Updates `values-pre.yaml` and `values-prod.yaml`
  - Optionally uses pull requests for approvals
- Add safeguards so prod promotions require manual review (even though Argo CD itself remains in auto-sync mode).

This keeps Argo CD’s reconciliation automated while preserving control and auditability at the Git layer.
